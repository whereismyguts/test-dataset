# Техническая документация: Abrau-Durso Reports v2

## Введение

Python-приложение для генерации аналитических отчетов по программе лояльности Abrau-Durso. Система обрабатывает данные о клиентах и транзакциях из двух источников (API и файлы CSV), стандартизирует их и генерирует отчеты на трех уровнях: общий, по группам брендов и по магазинам. Реализована унифицированная обработка транзакций из разных источников с сохранением консистентного формата данных для анализа.

## Направления для дальнейшего развития

1. **Интерактивный дашборд** - Разработать веб-интерфейс для визуализации ключевых метрик с фильтрацией

2. **Автоматизация отчетов** - Добавить возможность планирования и автоматической отправки отчетов по расписанию

3. **Интеграция с LLM** - Использовать LLM для ответов на вопросы, с пониманием какой отчет и метрика требуется, подгружая соответствующие данные в промпт

## Генерируемые отчеты

Система создает следующие отчеты:

### v1 (показан и одобрен, может быть использован)

**Комплексный отчет** (`abrau_*_report_[timestamp].xlsx`)

- Сводный отчет со всеми ключевыми метриками
- Включает данные по месяцу, группам брендов и точкам продаж

### v2 (по утвержденному ТЗ)

1. **Участники_Активные_Регистрации** (`1_Участники_Активные_Регистрации.xlsx`)
   - Анализ пользовательской базы по регионам и точкам продаж
   - Показывает общее количество участников, активных участников и новые регистрации

2. **Суммарный_объем_покупок** (`2_Суммарный_объем_покупок.xlsx`)
   - Общий объем покупок по точкам продаж
   - Включает количество чеков, суммы покупок, оплаты и скидки

3. **Конверсии** (`3_Конверсии.xlsx`)
   - Анализ конверсии новых участников в покупателей
   - Показывает долю клиентов, совершивших покупку после регистрации

4. **Сравнение периодов** (`4_Сравнение периодов.xlsx`)
   - Сравнение ключевых показателей между текущим и предыдущим периодами
   - Включает динамику регистраций и объемов покупок

5. **Сводка_по_юниту_региону** (`5_Сводка_по_юниту_региону.xlsx`)
   - Агрегация данных по регионам и юнитам
   - Показывает новые регистрации, количество и суммы покупок

6. **Динамика_и_отклонения** (`6_Динамика_и_отклонения.xlsx`)
   - Анализ изменений показателей во времени
   - Включает данные о регистрациях и объемах покупок по точкам

7. **Топ_точки** (`7_Топ_точки.xlsx`)
   - Рейтинг торговых точек по ключевым показателям
   - Ранжирование по количеству регистраций и среднему чеку

8. **Проблемные_точки** (`8_Проблемные_точки.xlsx`)
   - Анализ торговых точек с низкими показателями
   - Выявление точек с низким объемом продаж или средним чеком

## Руководство по запуску

```bash
python main.py -h

# Запуск с ограничением количества клиентов для тестирования
python main.py --sample 1000 --month 2025-03 

# Запуск с режимом production для полного набора данных
python main.py --production --month 2025-03 

# Запуск с генерацией отчетов версии 1 (устаревший формат)
python main.py --production --v1 --month 2025-03 

# Текущая актуальная команда для запуска:
python main.py --production --month 2025-03 --workers 10 --csv data/clients_v2.csv
```

## Ключевые функции

### Стандартизация данных о платежах

Функция `standardize_payment_data()` в `report_generators.py` объединяет данные из разных источников:

```python
def standardize_payment_data(transactions_df=None, payments_without_cards_df=None):
    """
    Стандартизирует данные о платежах из API-транзакций и платежей без карт в единый формат.
    
    Args:
        transactions_df (DataFrame): Данные транзакций из API (с картами)
        payments_without_cards_df (DataFrame): Данные платежей из файла (без карт)
        
    Returns:
        DataFrame: Объединенный DataFrame со стандартизированными колонками
    """
```

### Запуск отчетов (v2)

Функция `run_v2_reports()` в `main.py` запускает генерацию 8 отчетов

### Расширенный отчет (v1)

Метод `generate_monthly_report()` класса `ReportGenerator` создает комплексный отчет:

```python
def generate_monthly_report(self, customers, transactions, payments_without_cards_df, target_month=None):
    """
    Генерирует отчет о проникновении карт лояльности.
    Использует стандартизированные данные о транзакциях из всех источников.
    """
```

## Таблица метрик

Ниже представлена таблица метрик, используемых в проекте. Метрики реализованы с использованием стандартизированного формата данных о транзакциях и платежах. Таблица включает название метрики, описание и примечания по реализации.

| Метрика                                      | Описание                                                               | Примечания по реализации                                                     |
|----------------------------------------------|------------------------------------------------------------------------|------------------------------------------------------------------------------|
| Месяц / Группа бренда / Точка продаж         | Иерархический идентификатор в отчетах                                  | Используется для группировки данных на разных уровнях агрегации               |
| Кол-во клиентов                              | Количество уникальных клиентов с транзакциями                          | Реализовано через подсчет уникальных значений поля `customer_phone`           |
| Новые клиенты (регистрация=покупка)          | Новые клиенты с первой покупкой в течение дня после регистрации        | Использует данные о регистрации из профиля клиента и дату первой транзакции   |
| % новые клиенты от общего кол-ва клиентов    | Процент новых клиентов относительно общего количества                  | Метрика позволяет отслеживать эффективность привлечения новых клиентов        |
| Кол-во чеков по карте                        | Количество транзакций с использованием карт лояльности                 | Фильтрация по `payment_source == 'card'`                                    |
| Ср. чек по карте                             | Средний чек для транзакций с картами лояльности                        | Среднее значение `payment_amount` для транзакций с картами                    |
| Сумма оплат по карте                         | Общая сумма оплат с картами лояльности                                 | Сумма всех `payment_amount` для транзакций с картами                          |
| Сумма оплат бонусами по карте                | Общая сумма оплат бонусами с картами лояльности                        | Сумма всех `bonus_writeoff_total` для транзакций с картами                    |
| Сумма скидки по карте                        | Общая сумма скидок с картами лояльности                                | Сумма всех `discount_amount` для транзакций с картами                         |
| Кол-во чеков без карты                       | Количество транзакций без карт лояльности                              | Фильтрация по `payment_source == 'without_card'`                             |
| Сумма оплат без карты                        | Общая сумма оплат без карт лояльности                                  | Сумма всех `payment_amount` для транзакций без карт                           |
| Сумма скидки без карты                       | Общая сумма скидок без карт лояльности                                 | Сумма всех `discount_amount` для транзакций без карт                          |
| Ср. чек без карты                            | Средний чек для транзакций без карт лояльности                         | Среднее значение `payment_amount` для транзакций без карт                     |
| % Разн ср. чеков                             | Процентная разница между средними чеками с картами и без карт           | Позволяет оценить эффективность программы лояльности                          |
| Доля бонусов в обороте по картам             | Доля оплат бонусами в общем обороте транзакций с картами               | Ограничена 100% через функцию `validate_percentage`                           |
| Доля скидок в обороте по картам              | Доля скидок в общем обороте транзакций с картами                       | Рассчитывается относительно исходной стоимости (платеж + скидка)              |
| Доля скидок в обороте без карт               | Доля скидок в общем обороте транзакций без карт                        | **Обновлено:** Теперь использует формулу `discount / (payment + discount)` для согласованности с другими метриками |
| Проникновение % от чеков                     | Процент проникновения программы лояльности                             | Отношение количества чеков с картами к общему количеству чеков                |

## Оценка аналитической логики

### Обработка и агрегация данных

Проект использует библиотеку pandas для обработки данных, что является стандартным подходом для работы с большими наборами данных. Данные агрегируются на трех уровнях: общий (по месяцу), по группам брендов и по магазинам. Функция `classify_brand_group` обеспечивает корректную категоризацию магазинов, что гарантирует согласованность отчетов.

### Идентификация клиентов

Логика идентификации уникальных клиентов основана на использовании номера телефона (`customer_phone`) как уникального идентификатора. Это приемлемо, если номера телефонов действительно уникальны для каждого клиента. Однако стоит учитывать потенциальные ограничения, такие как возможность использования одного номера несколькими клиентами, хотя в данном анализе предполагается, что это не является проблемой.

### Расчет новых клиентов

Метрика "Новые клиенты (регистрация=покупка)" определяет новых клиентов как тех, чья первая покупка произошла в течение одного дня после регистрации. Это реализовано через сравнение дат регистрации и первой покупки с использованием условия `abs((registration_date - first_purchase_date).days) <= 1`. Логика кажется корректной, но рекомендуется уточнить у клиента, подходит ли окно в один день, учитывая возможные расхождения из-за часовых поясов или ошибок в данных.

### Финансовые метрики

Финансовые метрики, такие как общая сумма оплат, бонусные платежи и скидки, рассчитываются как суммы соответствующих полей транзакций.

### Потенциальная проблема

Обнаружена возможная несогласованность в расчете метрики "Доля скидок в обороте без карт". Для транзакций с картами лояльности доля рассчитывается как `total_discount / (total_payment + total_discount)`, что правильно отражает долю скидки относительно исходной цены (например, если скидка 1000 рублей, платеж 9000 рублей, исходная цена 10000 рублей, доля скидки — 10%). Для транзакций без карт используется формула `total_discount / total_payment`, что дает 1000 / 9000 ≈ 11,11%, что не соответствует стандартному подходу. Исследования в области розничной аналитики, такие как [Метрики лояльности: бизнес-показатели](https://blog.uxfeedback.ru/cxmetrics_part1/), подтверждают, что доля скидки должна рассчитываться относительно исходной цены для единообразия. Рекомендуется пересмотреть этот расчет.

## Архитектура системы

### Основные компоненты

- **DataProcessor** (`data_processing.py`) - загрузка и обработка данных из файлов и API
- **ReportGenerator** (`main_report_generator.py`) - создание комплексных отчетов
- **Report Functions** (`report_generators.py`) - набор функций для генерации отдельных отчетов
- **API Handler** (`api_client.py`) - взаимодействие с API для получения данных по клиентам и транзакциям
- **Common Utilities** (`common_utils.py`) - общие утилиты, конфигурация и логирование

### Процесс обработки данных

1. **Загрузка данных**:
   - Клиенты загружаются из CSV файла и через API
   - Транзакции получаются через API (с картами лояльности)
   - Оплаты без карт загружаются из CSV файла

2. **Стандартизация данных**:
   - Функция `standardize_payment_data()` унифицирует формат транзакций из разных источников
   - Добавляется поле `payment_source` для отслеживания источника данных ('card' или 'without_card')
   - Форматы дат, числовые типы и отсутствующие данные обрабатываются для обеспечения совместимости

3. **Генерация отчетов**:
   - Генерация отдельных отчетов через функции из `report_generators.py`
   - Создание комплексного отчета через `ReportGenerator.save_comprehensive_report()`

### Формат данных

#### Стандартизированная структура транзакций

```python
{
    'date': datetime,            # Дата транзакции
    'store_name': str,           # Название точки продажи
    'payment_amount': Decimal,   # Сумма оплаты
    'discount_amount': Decimal,  # Сумма скидки
    'receipt_id': str,           # ID чека/транзакции
    'customer_phone': str,       # Телефон клиента (может быть None для платежей без карт)
    'payment_source': str,       # Источник данных ('card' или 'without_card')
    'brand_group': str,          # Группа бренда
    # Дополнительные поля для транзакций с картами
    'bonus_writeoff_total': Decimal,  # Общая сумма списанных бонусов
    'bonus_writeon_total': Decimal,   # Общая сумма начисленных бонусов
}
```
